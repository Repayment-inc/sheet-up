# エージェント運用ルール

> **最重要**: 作業開始前に必ず `OBSIDIAN.md` を参照し、最新ルール・資料構成を把握すること。

## git
このリポジトリでは、エージェントによる自動化は必ず `github` MCP サーバー経由で GitHub と連携すること。

- Issue 作成は常に MCP サーバーの `create_issue` アクションを利用し、ローカルの `gh` や直接の API 呼び出しは禁止。
- Issue は「ひとつのユーザー操作／内部処理／検証タスク」に対応させ、実装・テスト・ドキュメントなどの個別ステップは原則分割する。
  - 例: 「ブックの CRUD」ではなく「ブック新規作成」「ブック名称変更」「ブック削除」「ブック読込（表示）」のように切り出す。
  - テスト追加やドキュメント更新も、機能実装と独立して必要に応じて別 Issue を立てる。
  - 分割が適さないと判断した場合は、統合する理由（依存関係・同時レビューが必須 等）を Issue 本文の冒頭に記載する。
- 1 Issue あたり最低 1 ブランチを必ず用意し、既存ブランチに別 Issue の作業を混在させない。小さなバグ修正でも `fix/...` などの専用ブランチを切ること。
- Issue のタイトルや本文、コミットメッセージ、プルリクエスト本文・タイトルは必ず日本語で記述すること。
- コードのステージングはローカルで行ってよいが、コミットは必ず MCP サーバーのコミット用エンドポイントを使い、`git commit` コマンドは直接実行しないこと。ただし、bun.lockファイルのファイルサイズが大きすぎるなど、何らか理由でmcp経由のコミットができなかった場合は、Userに確認した上で `git commit` を実行して良いものとする。
- コミットメッセージは Angular.js の Conventional Commits 形式に従い、`feat` / `fix` / `docs` / `style` / `refactor` / `perf` / `test` / `chore` のいずれかで始め、簡潔な説明を続ける（例: `feat: add OAuth login stub`）。
- プルリクエストの作成や更新も MCP サーバー（例: `create_pull_request`, `update_pull_request`）を通じて行い、直接の操作は禁止。
- MCP を使えなかった場合など、ルールから外れる対応を取ったときは、プルリクエスト本文に理由を必ず記録すること。

### 作業開始前のチェック
- `main` を最新状態に更新する（`git fetch` → fast-forward）。
- 変更を加える前に必ず派生ブランチを作成し、ブランチ名と作業内容の整合を確認する。
- ブランチ削除・履歴書き換えなどの破壊的操作を実行する際は、削除前にバックアップ用ブランチを作成するか、`git reflog` で復旧可能であることを確認する。
- MCP 以外の手段で git 操作を行う場合は、必ず事前にユーザーへ報告し、理由と対処を記録する。

### 変更適用前のセルフチェック
- PR/コミット前に必ず `git diff` で差分を確認し、意図しない大量削除やバイナリ化（Base64 文字列など）が含まれていないかチェックする。
- `github__create_or_update_file` / `push_files` でテキストを送る際は、ローカルからスクリプト等で内容を読み込んで JSON 文字列に変換し、手作業でのコピペを避ける。
- 変更ファイルは送信後に `cat` や `python3 - <<'PY' ... PY` などで再表示し、内容が期待どおりか二重確認する。
- 型チェックや `bun x tsc --noEmit` など、可能な範囲の自動テストを実行し、結果を記録する。

### ブランチ運用
- 既定ブランチは `main`。安定版として扱い、レビュー完了または自己確認済みの変更のみマージする。
- 作業開始時は `main` から派生ブランチを作成し、ブランチ名は `種類/概要` 形式とする（例: `feature/json-io`, `bugfix/sidebar-drag`, `chore/update-deps`）。
- 別 Issue の修正を同じブランチで続けて行わない。既存ブランチで未マージの変更がある場合は、必要に応じてクリーなブランチを作り直す。
- 大規模機能やリリース準備が必要な場合は、必要に応じて `release/vX.Y` ブランチを切り、検証完了後に `main` へマージする。
- ブランチへの直接 push を避け、PR マージで取り込む。緊急修正で直接 push した場合は、理由を PR または記録に残す。

### プルリクエスト
- すべての作業ブランチは GitHub PR を経て `main` にマージする。開発者が一人でも PR を作成し、変更内容・動作確認・残課題を記載する。
- PR タイトルと本文は日本語。タイトルは「`feat: ...`」などコミットと同様の形式に揃える。
- PR 本文には最低限以下を含めること:
  - 背景／目的
  - 主要な変更点（箇条書き可）
  - 動作確認やテスト結果
  - 残課題やフォローアップ（あれば）
- マージ時は Squash merge を推奨。複数コミットを保持したい場合のみ Merge commit を選択する。

### タグ・リリース
- リリースのタイミングで `vX.Y.Z` 形式（Semantic Versioning）で Git タグを付与する。
- タグを打つ際は、対応する PR やリリースノートを残して変更点をまとめる。
- 重要なマイルストーンも同様にタグ管理し、どのブランチ／コミットが基点かを明示する。

ワークフローが変わった際には、本ファイルを更新して最新のルールを共有すること。

## obsidian
このリポジトリでは、Obsidianに資料を残す際は、`obsidian_tools` MCP サーバー経由で Obsidian と連携すること。

### プロジェクトのルール及び各種資料
**必ず`OBSIDIAN.md` を参照、把握すること**
